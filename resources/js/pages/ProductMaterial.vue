<template>
    <div class="container-fluid px-4">
        <h4 class="mt-4">Material / Product Quotation</h4>
        <div class="card mt-3"  style="width: 100%;">
            <div class="card-body overflow-auto">
                <div class="table-responsive">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <button @click="btnAddUser" type="button" ref= "btnAddUser" class="btn btn-primary btn-sm">
                                <font-awesome-icon class="nav-icon" icon="fas fa-file" />&nbsp; Add New
                            </button>
                        </div>
                    </div>
                    <DataTable
                        width="100%" cellspacing="0"
                        class="table mt-2"
                        ref="tblUserMaster"
                        ajax="api/load_product_material"
                        :columns="productMaterialColumns"
                        :options="{
                            serverSide: true, //Serverside true will load the network
                            columnDefs:[
                                // {orderable:false,target:[0]}
                            ]
                        }"
                    >
                        <thead>
                            <tr>
                                <th>
                                    <font-awesome-icon class="nav-icon" icon="fa-cogs" />
                                </th>
                                <th>Control Number</th>
                                <th>Category</th>
                                <th>Created By</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                    </DataTable>
                </div>
            </div>
        </div>
    </div>
    <!-- @add-event="formProductMaterial" -->
    <ModalComponent icon="fa-file" modalDialog="modal-dialog modal-md" title="Add User" ref="modalAddUser">
        <template #body>
            <div class="row mt-3">
                <div class="row">
                    <div class="input-group flex-nowrap mb-2 input-group-sm">
                        <span class="input-group-text" id="addon-wrapping">Full Name:</span>
                        <Multiselect
                            placeholder="Select an option"
                            :searchable="true"
                            :close-on-select="true"
                        />
                    </div>
                </div>
            </div>
        </template>
        <template #footer>
            <button type="button" id= "closeBtn" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-success btn-sm"><font-awesome-icon class="nav-icon" icon="fas fa-save" />&nbsp;  Save</button>
        </template>
    </ModalComponent>
    <ModalComponent icon="fa-download" modalDialog="modal-dialog modal-xl" title="Quotations" ref="modalQuotations">
        <template #body>
            <div class="row mt-3">
                <div class="row">
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="input-group flex-nowrap mb-2 input-group-sm">
                                <span class="input-group-text" id="addon-wrapping">Created by :</span>
                                <span class="input-group-text" id="addon-wrapping">---</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group flex-nowrap mb-2 input-group-sm">
                                <span class="input-group-text" id="addon-wrapping">Status :</span>
                                <span class="input-group-text" id="addon-wrapping">---</span>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="input-group flex-nowrap mb-2 input-group-sm">
                                <span class="input-group-text" id="addon-wrapping">Control No. :</span>
                                <input v-model="frmItem.controlNo" type="text" class="form-control" id="inlineFormInputGroup">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group flex-nowrap mb-2 input-group-sm">
                                <span class="input-group-text" id="addon-wrapping">Status :</span>
                                <span class="input-group-text" id="addon-wrapping">---</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="col-6">
                            <div class="input-group flex-nowrap mb-2 input-group-sm">
                                <span class="input-group-text" id="addon-wrapping">Control No. :</span>
                                <input v-model="frmItem.controlNo" type="text" class="form-control" id="inlineFormInputGroup">
                            </div>
                        </div>
                            <div class="input-group flex-nowrap mb-2 input-group-sm">
                                <span class="input-group-text" id="addon-wrapping">Category. :</span>
                                <Multiselect
                                    v-model="frmItem.category"
                                    :close-on-select="true"
                                    :searchable="true"
                                    :options="commonVar.category"
                                />
                            </div>
                        </div>

                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="input-group flex-nowrap mb-2 input-group-sm">
                                <span class="input-group-text" id="addon-wrapping">Remarks. :</span>
                                <textarea v-model="frmItem.remarks" type="text" class="form-control" id="inlineFormInputGroup" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group flex-nowrap mb-2 input-group-sm">
                                <span class="input-group-text" id="addon-wrapping">Division. :</span>
                                <Multiselect
                                    v-model="frmItem.division"
                                    :close-on-select="true"
                                    :searchable="true"
                                    :options="commonVar.division"
                                    :change="onChangeDivision()"
                                />

                            </div>
                        </div>
                    </div>
                    <!--  -->
                    <div class="col-12 mt-2">
                        <button @click="addRowSaveItem"  type="button" class="btn btn-primary btn-sm" style="float: right !important;"><i class="fas fa-plus"></i> Add Items</button>
                        <br><br>
                    </div>
                    <div class="col-12">
                         <!-- <Multiselect
                                placeholder="-Select an Option-"
                            :close-on-select="true"
                            :searchable="true"
                            :options="commonVar.optAdminAccess"
                            @change="onChangeAdminAccess($event)"
                        /> -->
                        <!-- <input :value="selectedItemsId" v-model="pmItemsId" type="text" class="form-control" id="inlineFormInputGroup"> -->

                        <div class="row itemDesc" v-for="(rowSaveItem, indexItem) in rowSaveItems" :key="rowSaveItem.itemNo">
                            <div class="card mb-2">
                                    <h5 class="mb-0">
                                        <button id="" class="btn btn-link collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMan" aria-expanded="true" aria-controls="collapseMan">
                                            Item No. {{ rowSaveItem.itemNo }}

                                        </button>
                                    </h5>
                                <div id="collapseMan" class="collapse show" data-bs-parent="#accordionMain">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="col-12">
                                                    <button @click="addRowSaveDescription(indexItem,rowSaveItem.itemNo)" type="button" class="btn btn-primary btn-sm" style="float: right !important;"><i class="fas fa-plus"></i> Add Descriptions</button>
                                                    <br><br>

                                                </div>
                                                <table class="table table-striped">
                                                    <thead>
                                                        <tr>
                                                        <th scope="col">#</th>
                                                        <th scope="col" style="width: 30%;">PartCode/Type</th>
                                                        <th scope="col">Description/ItemName</th>
                                                        <th scope="col">Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr v-for="(rowSaveDescription, indexDescription) in rowSaveItem.rows" :key="rowSaveDescription.indexDescription">
                                                            <td>
                                                                <span>{{ indexDescription+1 }}</span>
                                                                <input v-model="rowSaveDescription.descItemNo" type="text" class="form-control" id="inlineFormInputGroup" placeholder="Partcode/Type">
                                                            </td>
                                                            <td>
                                                                <input v-model="rowSaveDescription.partcodeType" type="text" class="form-control" id="inlineFormInputGroup" placeholder="PartCode/Type">
                                                            </td>
                                                            <td>
                                                                <input v-model="rowSaveDescription.descriptionItemName" type="text" class="form-control" id="inlineFormInputGroup" placeholder="Description/Item Name">
                                                            </td>
                                                            <td>
                                                                <button @click="removeRowSaveDescription(indexItem, indexDescription)" class="btn btn-danger btn-sm" type="button" data-item-process="add">
                                                                    <li class="fa fa-trash"></li>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        <template #footer>
            <button type="button" id= "closeBtn" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            <button  @click="formSaveItem" type="submit" class="btn btn-success btn-sm"><font-awesome-icon class="nav-icon" icon="fas fa-save" />&nbsp;     Save</button>
        </template>
    </ModalComponent>
</template>

<script setup>
     import {
        onMounted,
        ref,
        reactive,
        toRef,
    } from 'vue'
    import DataTable from 'datatables.net-vue3';
    import DataTablesCore from 'datatables.net-bs5';
    import useFetch from '../composables/utils/useFetch';
    import useForm from '../composables/utils/useForm';
    import useCommon from '../composables/common';
    import useProductMaterial from '../composables/productmaterial';
    import ModalComponent from '../components/ModalComponent.vue';

    const {
        axiosFetchData,
    } = useFetch();
    const {
        axiosSaveData,
    } = useForm();
    const {
        modalCommon,
        commonVar,
    } = useCommon();
    const {
        modalPm,
        pmVar,
        frmItem,
        cardSaveClassifications,
        rowSaveClassifications,
        rowSaveDescriptions,
        rowSaveItems,
        getDescriptionByItemsId,
        getItemsById,
        onChangeDivision,
    } = useProductMaterial();

    DataTable.use(DataTablesCore);

    const selectedItemsId = ref(null);
    const modalQuotations = ref(null);
    const itemNoIndex = ref(1);

    const productMaterialColumns = [
        {   data : 'getActions',
             orderable: false,
            searchable: false,
            createdCell(cell){
                let btnGetMaterialById = cell.querySelector('#btnGetMaterialById');
                if(btnGetMaterialById !=null){
                    btnGetMaterialById.addEventListener('click',function(){
                        let itemsId = this.getAttribute('items-id')
                        let itemParams = {
                            itemsId : itemsId
                        }
                        getItemsById(itemParams);
                        selectedItemsId.value = itemsId;
                    });
                }
            }
        },
        { data : 'controlNo' },
        { data : 'category' },
        { data : 'createdBy' },
        { data : 'remarks' },
    ];

    onMounted ( async () =>{
        modalPm.Quotations = new Modal(modalQuotations.value.modalRef,{ keyboard: false });
        modalPm.Quotations.show();
    })

    const addRowSaveItem = () => {
        const newItemNo = rowSaveItems.value.length + 1;
        rowSaveItems.value.push( {
            itemNo: newItemNo,
            rows : [{
                descItemNo: newItemNo,
                partcodeType: 'N/A',
                descriptionItemName: "N/A"
            }]
        })
    }
    const addRowSaveClassification = () => {
        console.log();

        const newClassificationNo = cardSaveClassifications.value.length + 1;
        cardSaveClassifications.value.push( {
            newClassificationNo: newClassificationNo,
            rows: [
                {   classification: 'N/A',
                    qty: 0,
                    qty: "pcs",
                    unitPrice: "pcs",
                    remarks: "",
                }
            ]
        });
    }
    const addClassification = () => {
        const newClassificationNo = cardSaveClassifications.value.length + 1;
        cardSaveClassifications.value.push( {
            newClassificationNo: newClassificationNo,
            rows: [
                {   classification: 'N/A',
                    qty: 0,
                    qty: "pcs",
                    unitPrice: "pcs",
                    remarks: "",
                }
            ]
        });
        console.log(cardSaveClassifications);

    }
    const addRowSaveDescription = (itemNoIndex,newItemNo) => {
        rowSaveItems.value[itemNoIndex].rows.push( {
            descItemNo: newItemNo,
            partcodeType: 'N/A',
            descriptionItemName: "N/A",
        })
    }
    const removeRowSaveDescription =   (indexItem, indexDescription) => {
        rowSaveItems.value[indexItem].rows.splice(indexDescription, 1);
    }



    const formSaveItem = async () => {
        let formData =  new FormData();
        formData.append('itemsId', selectedItemsId.value);
        formData.append('controlNo', frmItem.value.controlNo);
        formData.append('category', frmItem.value.category);
        formData.append('remarks', frmItem.value.remarks);

        for (let index = 0; index < rowSaveItems.value.length; index++) {
            const elementRowSaveItems = rowSaveItems.value[index];

            for (let index = 0; index < elementRowSaveItems.rows.length; index++) {
                const elementRowSaveDescription = elementRowSaveItems.rows[index];
                const descItemNo = elementRowSaveDescription.descItemNo;
                const partcodeType = elementRowSaveDescription.partcodeType;
                const descriptionItemName = elementRowSaveDescription.descriptionItemName;
                [
                    ["itemNo[]", descItemNo],
                    ["partcodeType[]", partcodeType],
                    ["descriptionItemName[]", descriptionItemName]
                ].forEach(([key, value]) =>
                    formData.append(key, value)
                );
            }
        }
        axiosSaveData(formData,'api/save_item', (response) =>{
            console.log(response);
        });
    }

</script>
<style lang="scss" scoped>

</style>

